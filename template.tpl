___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "pmuipurchase",
  "version": 1,
  "securityGroups": [],
  "displayName": "PM Universal Integration Purchase",
  "categories": [
    "ADVERTISING",
    "ANALYTICS",
    "ATTRIBUTION",
    "CONVERSIONS",
    "MARKETING"
  ],
  "brand": {
    "id": "github.com_Profitmetrics-io",
    "displayName": "Profitmetrics.io",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDcuMC1jMDAwIDc5LmRhYmFjYmIsIDIwMjEvMDQvMTQtMDA6Mzk6NDQgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCAyMi41IChXaW5kb3dzKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDoxNEI3OTJGNjE1N0QxMUVDQUE0QkUxNTU5QjQwRkY2MiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDoxNEI3OTJGNzE1N0QxMUVDQUE0QkUxNTU5QjQwRkY2MiI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjE0Qjc5MkY0MTU3RDExRUNBQTRCRTE1NTlCNDBGRjYyIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjE0Qjc5MkY1MTU3RDExRUNBQTRCRTE1NTlCNDBGRjYyIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+DVquvwAACLdJREFUeNrsnQls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"
  },
  "description": "IMPORTANT: This script must trigger on the \"Purchase\" event or similar. This script has built-in support for Google Consent Mode. No additional consent required.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "publicId",
    "displayName": "Public ID (Required)",
    "simpleValueType": true,
    "alwaysInSummary": true,
    "help": "You can find your Public ID in ProfitMetrics.io under \"Websites\"",
    "valueHint": "1A2B3C4D5E6F7G8H",
    "notSetText": "Required",
    "valueValidators": [
      {
        "type": "STRING_LENGTH",
        "args": [
          16,
          16
        ]
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "dataLayerType",
    "displayName": "Select dataLayer type for quick set up",
    "selectItems": [
      {
        "value": "ecommerce.purchase.actionField.id",
        "displayValue": "ecommerce.purchase.actionField.id"
      },
      {
        "value": "ecommerce.transaction_id",
        "displayValue": "ecommerce.transaction_id"
      },
      {
        "value": "eventModel.transaction_id",
        "displayValue": "eventModel.transaction_id"
      },
      {
        "value": "transactionId",
        "displayValue": "transactionId"
      },
      {
        "value": "custom",
        "displayValue": "Custom fields"
      }
    ],
    "simpleValueType": true,
    "help": "Select your dataLayer type for quick set up, or choose custom if you chose to insert variables instead.",
    "alwaysInSummary": true,
    "notSetText": "Auto (Default)",
    "defaultValue": "auto"
  },
  {
    "type": "GROUP",
    "name": "customFieldsOverride",
    "displayName": "Custom fields (Override)",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "custom_transactionId",
        "displayName": "Transaction id",
        "simpleValueType": true,
        "help": "Insert a custom variable",
        "valueHint": "Transaction id",
        "enablingConditions": [],
        "notSetText": "Required"
      },
      {
        "type": "TEXT",
        "name": "custom_revenue",
        "displayName": "Revenue",
        "simpleValueType": true,
        "help": "Insert a custom variable",
        "valueHint": "Revenue",
        "notSetText": "Required"
      },
      {
        "type": "TEXT",
        "name": "custom_tax",
        "displayName": "Tax",
        "simpleValueType": true,
        "help": "Insert a custom variable",
        "valueHint": "Tax",
        "notSetText": "Required"
      },
      {
        "type": "TEXT",
        "name": "custom_shipping",
        "displayName": "Shipping",
        "simpleValueType": true,
        "help": "Insert a custom variable",
        "valueHint": "Shipping",
        "enablingConditions": [],
        "notSetText": "Required"
      },
      {
        "type": "TEXT",
        "name": "custom_currency",
        "displayName": "Currency",
        "simpleValueType": true,
        "help": "Insert a custom variable",
        "valueHint": "Currency",
        "enablingConditions": [],
        "notSetText": "Required"
      },
      {
        "type": "TEXT",
        "name": "custom_couponCode",
        "displayName": "Coupon Code",
        "simpleValueType": true,
        "help": "Insert a custom variable",
        "valueHint": "Coupon Code",
        "enablingConditions": [],
        "notSetText": "Required"
      },
      {
        "type": "TEXT",
        "name": "custom_products",
        "displayName": "Products (Array)",
        "simpleValueType": true,
        "help": "Insert a custom variable",
        "valueHint": "Products",
        "enablingConditions": [],
        "notSetText": "Required"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "additionalFields",
    "displayName": "Additional fields",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "customerEmail",
        "displayName": "Email",
        "simpleValueType": true,
        "help": "Customers email adresse",
        "valueHint": "test@test.com"
      },
      {
        "type": "TEXT",
        "name": "customerPhone",
        "displayName": "Phone",
        "simpleValueType": true,
        "help": "Customers phone number",
        "valueHint": "1234567890"
      },
      {
        "type": "TEXT",
        "name": "paymentMethod",
        "displayName": "Payment Method",
        "simpleValueType": true,
        "help": "The payment method used",
        "valueHint": "Credit Card"
      },
      {
        "type": "TEXT",
        "name": "shippingMethod",
        "displayName": "Shipping Method",
        "simpleValueType": true,
        "help": "The shipping method used",
        "valueHint": "Free shipping"
      },
      {
        "type": "TEXT",
        "name": "shippingCountry",
        "displayName": "Shipping Country",
        "simpleValueType": true,
        "help": "The country of the shipping address",
        "valueHint": "US"
      },
      {
        "type": "TEXT",
        "name": "shippingZipcode",
        "displayName": "Shipping Zipcode",
        "simpleValueType": true,
        "help": "The shipping method used",
        "valueHint": "1234"
      },
      {
        "type": "TEXT",
        "name": "shippingWeight",
        "displayName": "Shipping Weight",
        "simpleValueType": true,
        "help": "Recommended value in grams",
        "valueHint": "1000"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "settings",
    "displayName": "Tax settings",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SELECT",
        "name": "doesRevenueInclTax",
        "displayName": "Does Revenue Include Tax?",
        "selectItems": [
          {
            "value": true,
            "displayValue": "Yes"
          },
          {
            "value": false,
            "displayValue": "No"
          }
        ],
        "simpleValueType": true,
        "alwaysInSummary": true,
        "help": "Create a test order and check the value in the dataLayer"
      },
      {
        "type": "SELECT",
        "name": "doesRevenueInclShipping",
        "displayName": "Does Revenue Include Shipping?",
        "selectItems": [
          {
            "value": true,
            "displayValue": "Yes"
          },
          {
            "value": false,
            "displayValue": "No"
          }
        ],
        "simpleValueType": true,
        "alwaysInSummary": true,
        "help": "Create a test order and check the value in the dataLayer"
      },
      {
        "type": "SELECT",
        "name": "doesShippingInclTax",
        "displayName": "Does Shipping Include Tax?",
        "selectItems": [
          {
            "value": true,
            "displayValue": "Yes"
          },
          {
            "value": false,
            "displayValue": "No"
          }
        ],
        "simpleValueType": true,
        "alwaysInSummary": true,
        "help": "Create a test order and check the value in the dataLayer"
      },
      {
        "type": "SELECT",
        "name": "doesProductsInclTax",
        "displayName": "Does Products Include Tax?",
        "selectItems": [
          {
            "value": true,
            "displayValue": "Yes"
          },
          {
            "value": false,
            "displayValue": "No"
          }
        ],
        "simpleValueType": true,
        "alwaysInSummary": true,
        "help": "Create a test order and check the value in the dataLayer"
      },
      {
        "type": "SELECT",
        "name": "doesTaxInclShippingTax",
        "displayName": "Does Tax Include Shipping Tax?",
        "selectItems": [
          {
            "value": true,
            "displayValue": "Yes"
          },
          {
            "value": false,
            "displayValue": "No"
          }
        ],
        "simpleValueType": true,
        "alwaysInSummary": true,
        "help": "Create a test order and check the value in the dataLayer"
      },
      {
        "type": "TEXT",
        "name": "taxRate",
        "displayName": "VAT/Tax rate overrrite",
        "simpleValueType": true,
        "alwaysInSummary": true,
        "help": "Insert a fixed rate like 25 or something like al LookUpTable or a custom javascript calculation. If left empty the script will try to calculate the tax rate automatically.",
        "valueUnit": "%"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "other",
    "displayName": "Other",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "debugMode",
        "checkboxText": "Debug mode",
        "simpleValueType": true,
        "help": "If checked, the script will write messages to the console.",
        "displayName": "Debug mode"
      },
      {
        "type": "TEXT",
        "name": "documentCookie",
        "displayName": "document.cookie (Required)",
        "simpleValueType": true,
        "defaultValue": "{{document.cookie}}",
        "help": "How to create this variable:\n1. Click Variables\n2. Under \"User-Defined Variables\" click \"New\n3. Click \"Variable configuration\" and select \"Javascript variable\"\n4. Write \"document.cookie\" in Global Variable Name.\n5. Rename the variable to \"document.cookie\" and click save.",
        "valueValidators": [
          {
            "type": "REGEX",
            "args": [
              "r\u0027\\{\\{document\\.cookie\\}\\}\u0027"
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "LABEL",
    "name": "version",
    "displayName": "Version 2.1"
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

var version = 'universalintegration-GTM__2.1';

// Load GTM APIs
const JSON = require('JSON');
const log = require('logToConsole');
const injectScript = require('injectScript');
const copyFromWindow = require('copyFromWindow');
const getCookieValues = require('getCookieValues');
const encodeUriComponent = require('encodeUriComponent');
const decodeUriComponent = require('decodeUriComponent');
const copyFromDataLayer = require('copyFromDataLayer');
const makeNumber = require('makeNumber');
const makeString = require('makeString');
const assertThat = require('assertThat');
const getType = require('getType');

// Log debugMode status
if (data.debugMode) {
  log('debugMode:' + data.debugMode);
}

// Check if public ID is set
if (!data.publicId) {
  debugLog('Error: data.publicId is undefined.');
  data.gtmOnFailure();
  return;
}

// Debug function
function debugLog() {
    if (data.debugMode) {
        var message = '';
        for (var i = 0; i < arguments.length; i++) {
            var arg = arguments[i];
            if (typeof arg === 'undefined') {
                message += 'Value not available';
            } else if (typeof arg === 'object') {
                // Use JSON.stringify to convert objects and arrays to strings
                message += JSON.stringify(arg, null, 2); // The '2' adds formatting for easier reading
            } else {
                message += arg.toString();
            }
            if (i < arguments.length - 1) {
                message += ' ';
            }
        }
        log(message);
    }
}


// Utility Functions
// Helper function to check if a string resembles JSON structure.
function looksLikeJSON(value) {
    const type = getType(value);
    if (type !== 'string') return false;

    // Check if value resembles JSON structure
    const firstChar = value.trim().charAt(0);
    const lastChar = value.trim().charAt(value.trim().length - 1);

    if ((firstChar === '{' && lastChar === '}') || (firstChar === '[' && lastChar === ']')) {
        const parsedType = getType(JSON.parse(value));
        return parsedType === 'array' || parsedType === 'object';
    }

    return false;
}


// Convert null or empty string values to undefined
function toUndefined(value) {
    const result = (value === null || value === "") ? undefined : value;
    return result;
}


// Convert a value into a number, returning undefined for invalid numbers
function toUndefinedNumber(value) {
  const numberValue = makeNumber(value);
    if (numberValue !== numberValue) {  // Check for NaN
        return undefined;
    }
    return numberValue;
}



// Convert a value into a string, returning undefined for invalid strings
function toUndefinedString(value) {
    if (value == undefined || value === null || value === "" || value === "undefined") {
        return undefined;
    }
    const result = makeString(value);
    return result;
}



// Fetch the first value of a specified cookie.
function getCookieValue(cookieName) {
    let cookieValues = getCookieValues(cookieName);
    return (cookieValues && cookieValues.length > 0) ? cookieValues[0] : null;
}


// Check if a string resembles JSON structure.
function looksLikeJSON(str) {
    if (typeof str !== 'string') return false;
    str = str.trim();
    const result = (str.startsWith('{') && str.endsWith('}')) || (str.startsWith('[') && str.endsWith(']'));
    return result;
}


// Clean Orderspec
function omitUndefined(obj) {
    let newObj = {};
    for (let key in obj) {
        if (obj.hasOwnProperty(key) && obj[key] !== undefined) {
            newObj[key] = obj[key];
        }
    }
    return newObj;
}





// Construct the URL to send the orderspec data to ProfitMetrics and initiates the data send process.

function pmLogOrder(pid, version, orderspec) {
    var o = encodeUriComponent(JSON.stringify(orderspec));
    var cv = encodeUriComponent(version);
    var u = 'https://my.profitmetrics.io/l.php?v=1' + '&pid=' + encodeUriComponent(pid) + '&cv=' + cv + '&o=' + o;
    
    debugLog("pid: " + pid);
    debugLog("cv: " + cv);
    debugLog("orderspec: ", orderspec);
    debugLog("Encoded URL: ", u); // Log the complete URL



    var _pm_cc_marketing = null;
    var _pm_cc_statistics = null;
    
    let profitMetrics = copyFromWindow('profitMetrics');
		debugLog("Fetched profitMetrics from window: ", profitMetrics);


    if (profitMetrics && typeof profitMetrics == 'object') {
      if (typeof profitMetrics.cookieMarketingConsent == 'boolean') {
    _pm_cc_marketing = profitMetrics.cookieMarketingConsent;
    	debugLog("_pm_cc_marketing: " + _pm_cc_marketing);
}
if (typeof profitMetrics.cookieStatisticsConsent == 'boolean') {
    _pm_cc_statistics = profitMetrics.cookieStatisticsConsent;
    	debugLog("_pm_cc_statistics: " + _pm_cc_statistics);
}

    }
    

    var gacid = null;
    var gacid_source = null;

    if (_pm_cc_statistics !== false) {
        let pmGacid = getCookieValue('pmGacid');
				debugLog("Fetched pmGacid cookie: " + pmGacid);
	
        if (pmGacid) {
          	gacid_source = 'gatracker';
			gacid = decodeUriComponent(pmGacid);
				debugLog("Assigned gacid from pmGacid" + gacid);

        }
    }

    if (gacid === null) {
        let underscoreGAFromCookie = getCookieValue('_ga');
			debugLog("Fetched _ga cookie: " + underscoreGAFromCookie);
	if (underscoreGAFromCookie) {
		gacid_source = 'gacookie';
    	gacid = underscoreGAFromCookie;
    		debugLog("Assigned gacid from _ga cookie: " + gacid);
}
    }

    if (gacid !== null) {
    u += '&gacid=' + encodeUriComponent(gacid);
    	debugLog("Appended gacid to URL" + u);
}
	if (gacid_source !== null) {
    u += '&gacid_source=' + encodeUriComponent(gacid_source);
   		debugLog("Appended gacid_source to URL" + u);
}



// Updated GA4 code
const allCookiesString = data.documentCookie;
const allCookiesArray = allCookiesString.split(';');

// Extract the ga4 session id
const _implGa4SessId = allCookiesArray
    .filter(c => c.indexOf('_ga_') !== -1)
    .map(c => c.trim().split('.'))
    .filter(c => c && c.length >= 4)
    .map(c => {
        const namePart = c[0].trim();
        return namePart.substring(4, namePart.indexOf('=')) + ":" + c[2];
    })
    .join(',');

// Extract the ga4 session count
const _implGa4SessCount = allCookiesArray
    .filter(c => c.indexOf('_ga_') !== -1)
    .map(c => c.trim().split('.'))
    .filter(c => c && c.length >= 4)
    .map(c => {
        const namePart = c[0].trim();
        return namePart.substring(4, namePart.indexOf('=')) + ":" + c[3];
    })
    .join(',');

if (_implGa4SessId && _implGa4SessId.length > 0) {
    u += '&ga4_sessionid=' + encodeUriComponent(_implGa4SessId);
}

if (_implGa4SessCount && _implGa4SessCount.length > 0) {
    u += '&ga4_sessioncount=' + encodeUriComponent(_implGa4SessCount);
}

debugLog("u: ", u);  // Debug log the resulting string


    var trackspec = { 'error': 'empty' };
    let pmVisitSourceFromCookie = getCookieValue('pmVisitSource');
    if (pmVisitSourceFromCookie) {
        let decodedValue = decodeUriComponent(pmVisitSourceFromCookie);
        let parsedValue = JSON.parse(decodedValue);
        if (parsedValue) {
            trackspec = parsedValue;
        }
    }
		debugLog("Constructed trackspec: ", trackspec);


    if (trackspec !== null) {
    var t = encodeUriComponent(JSON.stringify(trackspec));
    u += '&t=' + t;
    	debugLog("Appended trackspec to URL" + u);
}


    if (_pm_cc_marketing !== false) {
        let pmGclid = getCookieValue('pmGclid');
        if (pmGclid) {
            var gclid = decodeUriComponent(pmGclid);
            if (gclid) {
                u += '&gclid=' + encodeUriComponent(gclid);
            }
        }
            debugLog("URL after appending gclid" + u);

        let pmfbp = getCookieValue('_fbp');
        if (pmfbp) {
            u += '&fbp=' + encodeUriComponent(pmfbp);
        }
        
			debugLog("URL after appending fbp" + u);

        let pmfbc = getCookieValue('_fbc');
        if (pmfbc) {
            u += '&fbc=' + encodeUriComponent(pmfbc);
        }
        
	        debugLog("URL after appending fbc" + u);
    }

   if (_pm_cc_marketing != null) {
    u += '&cc_marketing=' + encodeUriComponent(_pm_cc_marketing);
		debugLog("URL after appending cc_marketing" + u);
}
	if (_pm_cc_statistics != null) {
    u += '&cc_statistics=' + encodeUriComponent(_pm_cc_statistics);
		debugLog("URL after appending cc_statistics" + u);
}


    // GTM's injectScript
injectScript(u, function() {
    debugLog('Script loaded successfully.');
}, function() {
    debugLog('Error loading script.');
});

}

// Required fields
var transactionId;
var revenue;
var tax;
var shipping;
var currency;
var couponCode;
var products;

// Initialize reading from datalayer
let dataLayerType = data.dataLayerType;
debugLog("dataLayerType:" + dataLayerType);

function getDataLayerValue(key) {
    var value = copyFromDataLayer(key);
  debugLog("getDataLayerValue - complete");
    return value;
}


// Auto detect dataLayerType
if (dataLayerType === undefined || dataLayerType === "auto") {
    if (toUndefinedString(getDataLayerValue("ecommerce.purchase.actionField.id")) !== undefined) {
        debugLog("ecommerce.purchase.actionField.id selected");
        dataLayerType = "ecommerce.purchase.actionField.id";
    } else if (toUndefinedString(getDataLayerValue("ecommerce.transaction_id")) !== undefined) {
        debugLog("ecommerce.transaction_id selected");
        dataLayerType = "ecommerce.transaction_id";
    } else if (toUndefinedString(getDataLayerValue("eventModel.transaction_id")) !== undefined) {
        debugLog("eventModel selected");
        dataLayerType = "eventModel.transaction_id";
    } else if (toUndefinedString(getDataLayerValue("transactionId")) !== undefined) {
        debugLog("transactionId selected");
        dataLayerType = "transactionId";
    } else {
        debugLog("No dataLayer found");
    }
}

// Look up the data based on dataLayerType
debugLog("dataLayer switch started");
switch (dataLayerType) {

  case "ecommerce.purchase.actionField.id":
    transactionId = toUndefinedString(getDataLayerValue("ecommerce.purchase.actionField.id"));
    revenue = toUndefinedNumber(getDataLayerValue("ecommerce.purchase.actionField.revenue"));
    tax = toUndefinedNumber(getDataLayerValue("ecommerce.purchase.actionField.tax"));
    shipping = toUndefinedNumber(getDataLayerValue("ecommerce.purchase.actionField.shipping"));
    currency = toUndefinedString(getDataLayerValue("ecommerce.currencyCode"));
    couponCode = toUndefinedString(getDataLayerValue("ecommerce.purchase.actionField.coupon"));
    products = toUndefined(getDataLayerValue("ecommerce.purchase.products"));
    break;

  case "ecommerce.transaction_id":
    transactionId = toUndefinedString(getDataLayerValue("ecommerce.transaction_id"));
    revenue = toUndefinedNumber(getDataLayerValue("ecommerce.value"));
    tax = toUndefinedNumber(getDataLayerValue("ecommerce.tax"));
    shipping = toUndefinedNumber(getDataLayerValue("ecommerce.shipping"));
    currency = toUndefinedString(getDataLayerValue("ecommerce.currency"));
    copyFromDataLayer("ecommerce.coupon");
    products = toUndefined(getDataLayerValue("ecommerce.items"));
    break;

  case "eventModel.transaction_id":
    transactionId = toUndefinedString(getDataLayerValue("eventModel.transaction_id"));
    revenue = toUndefinedNumber(getDataLayerValue("eventModel.value"));
    tax = toUndefinedNumber(getDataLayerValue("eventModel.tax"));
    shipping = toUndefinedNumber(getDataLayerValue("eventModel.shipping"));
    currency = toUndefinedString(getDataLayerValue("eventModel.currency"));
    couponCode = toUndefinedString(getDataLayerValue("eventModel.couponCode"));
    products = toUndefined(getDataLayerValue("eventModel.items"));
    break;

  case "transactionId":
    transactionId = toUndefinedString(getDataLayerValue("transactionId"));
    revenue = toUndefinedNumber(getDataLayerValue("transactionTotal"));
    tax = toUndefinedNumber(getDataLayerValue("transactionTax"));
    shipping = toUndefinedNumber(getDataLayerValue("transactionShipping"));
    currency = undefined;
    couponCode = undefined;
    products = toUndefined(getDataLayerValue("transactionProducts"));
    break;

  case "custom":
    transactionId = toUndefinedString(data.custom_transactionId);
    revenue = toUndefinedNumber(data.custom_revenue);
    tax = toUndefinedNumber(data.custom_tax);
    shipping = toUndefinedNumber(data.custom_shipping);
    currency = toUndefinedString(data.custom_currency);
    couponCode = toUndefinedString(data.custom_couponCode);
    products = toUndefined(data.custom_products);
    break;
}


// Set or Override if custom fields are set
if (data.custom_transactionId != undefined) {
    transactionId = toUndefinedString(data.custom_transactionId);
    debugLog ("Override transactionId");}
if (data.custom_revenue != undefined) {
    revenue = toUndefinedNumber(data.custom_revenue);
     debugLog ("Override revenue");}
if (data.custom_tax != undefined) {
    tax = toUndefinedNumber(data.custom_tax);
    debugLog ("Override tax");}
if (data.custom_shipping != undefined) {
    shipping = toUndefinedNumber(data.custom_shipping);
    debugLog ("Override shipping");}
if (data.custom_currency != undefined) {
    currency = toUndefinedString(data.custom_currency);
    debugLog ("Override currency");}
if (data.custom_couponCode != undefined) {
    couponCode = toUndefinedString(data.custom_couponCode);
    debugLog ("Override couponCode");}
if (data.custom_products != undefined) {
    products = toUndefined(data.custom_products);
    debugLog ("Override products");}



// Log updated values of required fields
debugLog("transactionId:" + transactionId);
debugLog("revenue:" + revenue);
debugLog("tax:" + tax);
debugLog("shipping:" + shipping);
debugLog("currency:" + currency);
debugLog("couponCode:" + couponCode);
debugLog("products", products);


// Settings
var doesRevenueInclTax = data.doesRevenueInclTax;
var doesRevenueInclShipping = data.doesRevenueInclShipping;
var doesShippingInclTax = data.doesShippingInclTax;
var doesTaxInclShippingTax = data.doesTaxInclShippingTax;
var doesProductsInclTax = data.doesProductsInclTax;

// Log settings
debugLog("Settings - doesRevenueInclTax:" + doesRevenueInclTax);
debugLog("Settings - doesRevenueInclShipping:" + doesRevenueInclShipping);
debugLog("Settings - doesShippingInclTax:" + doesShippingInclTax);
debugLog("Settings - doesTaxInclShippingTax:" + doesTaxInclShippingTax);
debugLog("Settings - doesProductsInclTax:" + doesProductsInclTax);


// Define taxRate
var taxRate;

// Helper function to calculate tax rate
function calculateTaxRate(adjustedTax, adjustedRevenue) {
    return (adjustedTax / adjustedRevenue) * 100;

}

// Helper function to adjust for different settings
function caseFunction(revenue, tax, shipping) {
    let adjustedRevenue = revenue;
    let adjustedTax = tax;
    debugLog("adjustedRevenue (Start): " + adjustedRevenue);
    debugLog("adjustedTax (Start): " + adjustedTax);

    if (doesRevenueInclTax && doesRevenueInclShipping && doesTaxInclShippingTax) {
        adjustedRevenue = revenue - tax;
        adjustedTax = tax;
        debugLog("adjustedRevenue (End 10): " + adjustedRevenue);
        debugLog("adjustedTax (End 10): " + adjustedTax);
        return calculateTaxRate(adjustedTax, adjustedRevenue);
    }

    if (doesRevenueInclTax && data.doesShippingInclTax && doesTaxInclShippingTax) {
        adjustedRevenue = revenue + shipping - tax;
        adjustedTax = tax;
        debugLog("adjustedRevenue (End 9): " + adjustedRevenue);
        debugLog("adjustedTax (End 9): " + adjustedTax);
        return calculateTaxRate(adjustedTax, adjustedRevenue);
    }

    if (doesRevenueInclTax && data.doesRevenueInclShipping && doesShippingInclTax) {
        adjustedRevenue = revenue - shipping - tax;
        adjustedTax = tax;
        debugLog("adjustedRevenue (End 8): " + adjustedRevenue);
        debugLog("adjustedTax (End 8): " + adjustedTax);
        return calculateTaxRate(adjustedTax, adjustedRevenue);
    }

    if (doesRevenueInclShipping && doesTaxInclShippingTax) {
        adjustedRevenue = revenue;
        adjustedTax = tax;
        debugLog("adjustedRevenue (End 7): " + adjustedRevenue);
        debugLog("adjustedTax (End 7): " + adjustedTax);
        return calculateTaxRate(adjustedTax, adjustedRevenue);
    }

    if (doesRevenueInclTax && doesTaxInclShippingTax) {
        adjustedRevenue = revenue + shipping + tax;
        adjustedTax = tax;
        debugLog("adjustedRevenue (End 6): " + adjustedRevenue);
        debugLog("adjustedTax (End 6): " + adjustedTax);
        return calculateTaxRate(adjustedTax, adjustedRevenue);
    }

    if (doesRevenueInclShipping && doesTaxInclShippingTax) {
        adjustedRevenue = revenue - shipping;
        debugLog("adjustedRevenue (End 5): " + adjustedRevenue);
        debugLog("adjustedTax (End 5): " + adjustedTax);
        return calculateTaxRate(adjustedTax, adjustedRevenue);
    }

    if (!doesRevenueInclShipping && doesTaxInclShippingTax) {
        adjustedRevenue = revenue + shipping;
        adjustedTax = tax;
        debugLog("adjustedRevenue (End 4): " + adjustedRevenue);
        debugLog("adjustedTax (End 4): " + adjustedTax);
        return calculateTaxRate(adjustedTax, adjustedRevenue);
    }

    if (doesRevenueInclShipping) {
        adjustedRevenue = revenue - shipping;
        debugLog("adjustedRevenue (End 3): " + adjustedRevenue);
        debugLog("adjustedTax (End 3): " + adjustedTax);
        return calculateTaxRate(adjustedTax, adjustedRevenue);
    }

    if (doesRevenueInclTax) {
        adjustedRevenue = revenue - tax;
        debugLog("adjustedRevenue (End2): " + adjustedRevenue);
        debugLog("adjustedTax (End 2): " + adjustedTax);
        return calculateTaxRate(adjustedTax, adjustedRevenue);
    }

    // Default case if none of the conditions are met
    return calculateTaxRate(adjustedTax, adjustedRevenue);
}


// Check if taxRate is undefined and calculate it if necessary
if (typeof data.taxRate !== 'undefined') {
    taxRate = toUndefinedNumber(data.taxRate);
    debugLog("taxRate Overwrite:" + taxRate);
} else {
    // Calculate taxRate using caseFunction
    taxRate = caseFunction(revenue, tax, shipping);
}



// Calculate taxAddition and taxDeduction based on taxRate
var taxAddition = 1 + (taxRate / 100);
var taxDeduction = 1 - (taxRate / (100 + taxRate));

debugLog("Calculated taxRate:" + taxRate);
debugLog("Calculated taxAddition:" + taxAddition);
debugLog("Calculated taxDeduction:" + taxDeduction);

// Calculate Shipping amounts
var ShippingExTax = doesShippingInclTax ? (shipping * taxDeduction) : shipping;
var ShippingInklTax = doesShippingInclTax ? shipping : ShippingExTax * taxAddition;

debugLog("Calculated ShippingExTax:" + ShippingExTax);
debugLog("Calculated ShippingInklTax:" + ShippingInklTax);

// Calculate Total Revenue amounts
var baseRevenueExTax = doesRevenueInclTax ? (revenue * taxDeduction) : revenue;
var baseRevenueInklTax = doesRevenueInclTax ? revenue : (revenue + tax);

debugLog("Calculated baseRevenueExTax:" + baseRevenueExTax);
debugLog("Calculated baseRevenueInklTax:" + baseRevenueInklTax);

var totalRevenueExTax = doesRevenueInclShipping ? baseRevenueExTax : (baseRevenueExTax + ShippingExTax);
var totalRevenueInklTax = doesRevenueInclShipping ? baseRevenueInklTax : (baseRevenueInklTax + ShippingInklTax);

debugLog("Calculated TotalRevenueExTax:" + totalRevenueExTax);
debugLog("Calculated TotalRevenueInklTax:" + totalRevenueInklTax);

// Additional fields
var email = toUndefinedString(data.customerEmail);
var paymentMethod = toUndefinedString(data.paymentMethod);
var shippingMethod = toUndefinedString(data.shippingMethod);
var shippingCountry = toUndefinedString(data.shippingCountry);
var shippingZipcode = toUndefinedString(data.shippingZipcode);
var shippingWeight = toUndefinedNumber(data.shippingWeight);
var phone = toUndefinedString(data.customerPhone);

var parsedPhone;
if (typeof phone === 'string') {
    parsedPhone = phone.split('').filter(function(char) {
        return '0123456789'.indexOf(char) !== -1;
    }).join('');

    parsedPhone = toUndefinedString(parsedPhone);
}


// Create orderspec
var pmId = data.publicId;
var parsedProducts;
// Check if products is a string that might be JSON.
if (getType(products) === 'string' && looksLikeJSON(products)) {
    parsedProducts = JSON.parse(products);
    if (!parsedProducts) {
        debugLog('Error: Failed to parse products string.');
        data.gtmOnFailure();
        return;
    }
} else {
    parsedProducts = products; // Assume it's already an array or object
}

var mappedProducts = [];

if (getType(parsedProducts) === 'array') {
    for (var i = 0; i < parsedProducts.length; i++) {
        var product = parsedProducts[i];
        var productId;

        // Determine the appropriate ID selector
        if (product.id) {
            productId = product.id;
        } else if (product.sku) {
            productId = product.sku;
        } else if (product.item_id) {
            productId = product.item_id;
        }  else if (product.itemId) {
            productId = product.itemId;
        }

        var mappedProduct = {
            sku: productId,
            qty: product.quantity,
            priceExVat: product.price * taxDeduction
        };

        mappedProducts.push(mappedProduct);
      debugLog("mappedProduct:", mappedProduct);
    }
} else {
    debugLog("Parsed products is not an array. Type detected:" + getType(parsedProducts));
    data.gtmOnFailure();
    return;
}


// Define orderspec
var orderspec = {
    id: toUndefinedString(transactionId),
    orderEmail: toUndefinedString(email),
    customerPhone: toUndefinedNumber(parsedPhone),
    shippingMethod: toUndefinedString(shippingMethod),
    shippingCountry: toUndefinedString(shippingCountry),
    shippingZipcode: toUndefinedString(shippingZipcode),
    shippingWeight: toUndefinedNumber(shippingWeight),
    paymentMethod: toUndefinedString(paymentMethod),
    currency: toUndefinedString(currency),
    voucherCode: toUndefinedString(couponCode),
    priceShippingExVat: toUndefinedNumber(ShippingExTax),
    priceTotalExVat: toUndefinedNumber(totalRevenueExTax),
    priceTotalInclVat: toUndefinedNumber(totalRevenueInklTax),
    products: mappedProducts
};

// Remove properties with undefined values from orderspec
orderspec = omitUndefined(orderspec);

// Log the entire cleaned orderspec object
debugLog("Orderspec preview:", orderspec);


// Check for undefined properties in orderspec and log errors
for (var prop in orderspec) {
    if (orderspec.hasOwnProperty(prop) && orderspec[prop] === undefined) {
        debugLog(prop + " is undefined");
    }
}

pmLogOrder(pmId, orderspec);
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "profitMetrics"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedKeys",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://my.profitmetrics.io/l.php*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []
setup: ''


___NOTES___

Created on 11.8.2023 22.05.58


